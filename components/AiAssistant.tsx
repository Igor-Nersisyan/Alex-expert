import React, { useState, useRef, useEffect } from 'react';
import { MessageCircle, X, Send, Bot, Sparkles, ChevronDown } from 'lucide-react';
import { GoogleGenAI, Chat } from "@google/genai";
import ReactMarkdown from 'react-markdown';
import { PROJECTS, PROCESS_STEPS, DEVELOPER_INFO } from '../constants';

// Системный промпт (используется только при наличии API ключа) **ЗАПРЕЩЕНО ИЗМЕНЯТЬ**
const SYSTEM_PROMPT = `
Ты — AI-Business Partner старшего разработчика по имени ${DEVELOPER_INFO.name}.
Твоя главная цель: ВОВЛЕЧЬ клиента в диалог, выяснить его потребности и только потом предложить решение.
Твой стиль общения: профессиональный, дружелюбный, лаконичный. Ты эксперт в AI-автоматизации.

ТВОЙ АЛГОРИТМ ОБЩЕНИЯ:
1.  **Выявление потребностей:** Задай уточняющий вопрос (стартап или бизнес? автоматизация или новый продукт?).
2.  **Презентация:** Используй ПОДРОБНУЮ БАЗУ ЗНАНИЙ ниже, чтобы подобрать точный пример. Расскажи детали функционала, если это релевантно (стек, интеграции).
3.  **Закрытие:** Если клиент готов, предложи заполнить форму и используй тег [ACTION:SCROLL_TO_CONTACT].

НЕЛЬЗЯ пытаться продать сразу, тебе нужно сначала выявить потребности клиента, НЕ ПЕРЕСКАКИВАЙ ЭТАПЫ ОБЩЕНИЯ

ПРАВИЛА:
1.  Ответы емкие, но информативные. Если спрашивают детали реализации — отвечай подробно, используя базу знаний.
2.  Всегда заканчивай вопросом.
3.  Если пришло время называть цену, называй вилкой "от X до Y" (бери из справочника).







# БАЗА ЗНАНИЙ (Context Injection):

## AI News / Nexus AI / Техноновости

AI News, Nexus AI и Техноновости — это проект-агрегатор новостей из мира искусственного интеллекта. В системе собраны значимые новости, события и обновления, которые так или иначе влияют на развитие AI-индустрии.

Пользователь может:

* фильтровать новости по темам и категориям;
* выбирать свою роль (читатель, разработчик, фаундер и другие).

В каждой новости встроен чат с AI-агентом. Агент обсуждает новость с пользователем, адаптируя стиль и глубину ответа под выбранную роль.
Например:

* для разработчика — более технические и детальные объяснения;
* для фаундера — фокус на бизнес-эффекты и возможности;
* для обычного читателя — упрощённые и обзорные комментарии.

С агентом можно:

* обсудить конкретную новость;
* задать уточняющие вопросы;
* найти похожие или связанные новости;
* глубже разобраться в контексте события.

Проект реализован с использованием Google AI Studio.

---

## Content AI

Content AI — это платформа для комплексной генерации контента для социальных сетей и digital-каналов. Проект закрывает полный цикл работы с контентом — от планирования до финальных форматов.

### Контент-план

Первый раздел — генерация контент-плана.
Пользователь указывает:

* нишу бизнеса;
* целевую аудиторию;
* каналы публикации (Telegram, email-рассылка, YouTube и другие);
* время публикации;
* частоту публикаций;
* темы контента.

На основе этих данных система генерирует связанный контент-план, который используется во всех последующих разделах.

### Рассылки и посты

Раздел позволяет генерировать:

* email-рассылки;
* посты для социальных сетей.

Контент создаётся на основе ранее сгенерированного контент-плана.

### Подкасты

В этом разделе контент преобразуется в аудио с использованием Eleven Labs.

Пользователь выбирает:

* период плана (например, неделя);
* конкретный пост из контент-плана;
* тему подкаста;
* длительность;
* пол диктора;
* конкретный голос.

На выходе получается готовый аудиоконтент.

### Видео-аватары

Раздел для создания видео с AI-аватарами.

Пользователь:

* выбирает тему из контент-плана;
* выбирает аватар из HeyGen;
* озвучивает видео.

Также возможно использовать аудио, созданное ранее в разделе «Подкасты», и накладывать голос из Eleven Labs на аватар из HeyGen.

### Лонгриды

Раздел для генерации развернутых статей для блогов.

Возможности:

* выбор объёма текста (например, 4000 или 8000 слов);
* генерация статей на основе контент-плана;
* добавление собственных статей для доработки или расширения.

### SEO-статьи

Раздел предназначен для создания статей, оптимизированных под поисковые системы.

Пользователь указывает:

* тему;
* ключевые слова, которые должны быть включены;
* общее количество слов.

Результат — SEO-оптимизированная статья, подходящая для блога или сайта.

### Лид-магниты

Раздел для создания лид-магнитов (гайды, чек-листы и другие полезные материалы).

Процесс:

* выбор типа лид-магнита;
* выбор темы;
* определение целевой аудитории;
* генерация структуры;
* генерация контента по утверждённой структуре.

## Russian Cities / Города России

Russian Cities (Города России) — это информационный проект, посвящённый крупным городам России. В системе представлено 10 городов:

* Москва
* Санкт-Петербург
* Казань
* Сочи
* Новосибирск
* Екатеринбург
* Нижний Новгород
* Владивосток
* Калининград
* Красноярск

Пользователь выбирает интересующий его город и получает структурированную информацию по нескольким разделам.

### История

В первой вкладке представлена краткая история города. Здесь описаны ключевые исторические события, этапы развития и значимые факты.
Ниже расположена галерея с фотографиями города, демонстрирующими его архитектуру, атмосферу и знаковые места.

### Развитие

Раздел посвящён социально-экономическому развитию города.
Здесь представлены:

* стратегии развития города до 2030 года и далее;
* локальные новости развития — менее масштабные, но актуальные события и изменения на городском уровне.

### Места

Раздел с рекомендациями достопримечательностей и интересных мест для посещения.
В зависимости от выбранного города пользователю предлагаются ключевые локации (например, Красная площадь и Кремль для Москвы, другие знаковые места для остальных городов).
Раздел ориентирован на прогулки, туризм и культурный досуг.

### Рестораны

Раздел для поиска заведений общественного питания.

Пользователь может:

* фильтровать рестораны по цене;
* выбирать тип заведения;
* выбирать кухню;
* просматривать отзывы;
* открывать карту города и выбирать заведения прямо на карте.

### AI-ассистент

В проекте встроен AI-ассистент, который:

* помогает навигировать между разделами;
* отвечает на вопросы пользователя о городе, местах и возможностях сервиса.

---

## AI-Банк / Банковский портал сотрудников

AI-Банк — это веб-приложение для обучения и адаптации новых сотрудников банка. Платформа используется для создания и прохождения обучающих курсов внутри организации.

### Административная часть

С точки зрения администратора доступна панель управления, в которой отображается:

* статистика по должностям;
* количество курсов;
* количество сотрудников;
* последняя активность и другие метрики.

Администратор может:

1. Создавать должности (например, кредитный консультант).
2. Создавать курсы и привязывать их к конкретным должностям.

### Создание курсов

При создании курса:

* уроки генерируются с помощью искусственного интеллекта;
* для каждого урока автоматически создаются вопросы и задания.

Форматы уроков:

* текстовая версия (базовая);
* аудиоверсия, сгенерированная на основе текста с помощью Eleven Labs;
* видеоверсия, сгенерированная на основе аудио с помощью HiGen;
* презентации, которые можно добавлять к урокам.

### Управление сотрудниками

Администратор может:

* добавлять сотрудников в систему;
* назначать им курсы;
* отслеживать их прогресс в отдельном разделе.

### Пользовательская часть (сотрудник)

С точки зрения сотрудника:

* пользователь заходит в систему под своей учётной записью;
* видит список доступных ему курсов;
* проходит обучение и получает оценки за задания.

В систему интегрирован AI-ассистент:

* он проверяет ответы на открытые вопросы;
* помогает с обратной связью и оценкой знаний.

## Панель управления недвижимостью

Панель управления недвижимостью — это веб-приложение для управления объектами недвижимости и финансовыми показателями. Решение ориентировано на гарантов, риэлторов и управляющих объектами.

### Дашборд и основные разделы

В системе доступны следующие разделы:

* **Дашборд**
  Отображает сводную статистику по всем объектам и операциям.

* **Объекты**
  Список всех объектов недвижимости с возможностью просмотра и редактирования данных.

* **Карта**
  Интерактивная карта с размещёнными объектами недвижимости.

* **Аналитика**
  Содержит ключевые финансовые и операционные показатели:

  * общий доход;
  * количество оплаченных платежей;
  * количество платежей в ожидании;
  * количество просрочек;
  * распределение платежей по статусам;
  * доход по каждому объекту.

* **Настройки**
  В настройках можно:

  * экспортировать данные в PDF и Excel;
  * включать и отключать уведомления;
  * настраивать валюту отображения;
  * управлять другими параметрами системы.

### Интеграция с Google Sheets

Первый шаг при работе с системой — подключение Google Sheets.

* Пользователь подключает существующую таблицу по заданному шаблону.
* Разделы веб-приложения связываются с исходными данными таблицы.
* Все изменения, внесённые через веб-интерфейс, автоматически синхронизируются с Google Sheets.
* Аналогично, изменения в таблице отражаются в системе.

### Работа с AI-агентом

В систему интегрирован AI-агент, который позволяет управлять данными различными способами:

* загрузка файлов (чеки оплат, договоры аренды и другие документы);
* голосовой ввод команд;
* текстовый ввод запросов.

AI-агент может:

* добавлять новые данные;
* изменять существующие записи;
* удалять данные;
* выполнять действия в зависимости от запроса пользователя.

---

## IT-Sales / IT-Sales Pro / IT-Sales AI / IT-Outsourcing Pro

Это линейка веб-приложений для IT-продаж и аутсорсинга, объединённых общим набором инструментов для контроля качества, обучения и повышения эффективности менеджеров по продажам.

### Нейро-контроль качества

Раздел для анализа работы менеджеров с клиентами.

Возможности:

* загрузка аудиозаписи разговора;
* вставка текстовой расшифровки звонка;
* автоматический анализ звонка;
* оценка качества работы менеджера и ключевых показателей общения.

### Генератор коммерческих предложений

Инструмент для создания коммерческих предложений для IT-услуг.

Процесс:

* заполнение данных клиента;
* генерация персонализированного коммерческого предложения на основе введённых данных.

### Скрипты продаж

Раздел для работы со сценариями продаж.

Пользователь может:

* выбрать тип сценария (холодный звонок, входящая заявка, возврат клиента);
* персонализировать сценарий под задачу;
* сгенерировать новый скрипт;
* загрузить существующий скрипт и доработать его.

### Тренажёры продаж

Раздел для обучения и тренировки менеджеров.

Функциональность:

* добавление менеджеров в систему;
* выбор уровня сложности тренировки (4 уровня);
* формат тренировки:

  * текстовые переговоры;
  * голосовой звонок.

Для звонков используется AI-агент, соответствующий выбранному уровню сложности.
На максимальном уровне сложности агент моделирует поведение руководителя компании, с которым крайне сложно договориться.

По завершении тренировки пользователь получает:

* статистику по диалогу;
* детальную обратную связь.

### Дашборд

Раздел для руководителей и администраторов.

Позволяет:

* отслеживать прогресс менеджеров;
* анализировать динамику развития навыков;
* оценивать эффективность обучения и тренировок.

## Мира AI — интеллектуальный AI-рекрутер

Мира AI — это AI-рекрутер для подбора персонала и автоматизации HR-процессов.

### Интерфейс

* Слева — чат для общения с пользователем.
* Справа — динамическая область, которая визуализирует контент в зависимости от запроса. Контент генерируется на ходу, нет статичных страниц.

### Функциональность

* Ответы на вопросы пользователя: возможности системы, стоимость, сравнение с обычными рекрутёрами.
* Подключение к платформам поиска кандидатов, например, HeadHunter.
* Поиск кандидатов в любое время дня и ночи.
* Проведение интервью с кандидатами.
* Сбор и визуализация статистики по кандидатам, чтобы пользователь мог выбрать наиболее подходящего кандидата.

Мира AI упрощает подбор персонала, ускоряет процесс найма и повышает точность оценки кандидатов.

---

## Дизайнер AI интерьеров

Проект предназначен для улучшения визуального оформления помещений и генерации дизайн-проектов с помощью AI.

### Процесс работы

1. **Создание проекта**

   * Выбор типа помещения и его назначения.
   * Загрузка фотографии помещения.
   * Указание цели использования помещения.

2. **Анализ помещения**

   * Формируется «паспорт объекта» с аудитом, ключевыми проблемами и рекомендациями.
   * Определяются концепции, перспективы и варианты преображения.

3. **Генерация визуального дизайна**

   * Выбор стиля, дополнительных пожеланий и основного цвета.
   * Генерация нескольких вариантов дизайна.
   * Возможность доработки выбранного варианта или повторной генерации через промпт.

4. **Финализация проекта**

   * Получение рекомендаций по материалам.
   * Генерация списка покупок для реализации проекта.
   * Экспорт готового проекта в PDF.

Проект позволяет создавать полноценные дизайн-проекты, управлять стилем и материалами, а также получать готовые инструкции для реализации.

## Aura Estate AI

Aura Estate AI — это концепт интеллектуального AI-консультанта для рынка премиальной загородной недвижимости.
Агент выступает не как чат-бот-продавец, а как персональный эксперт, который помогает клиенту сформировать чёткое понимание будущего дома — от идеи до плана.

### Роль и подход

* Работает с «холодной» аудиторией, которая только задумывается о доме.
* Не продаёт напрямую, а снимает неопределённость и страх выбора.
* Помогает сформулировать реальные потребности и желания пользователя.

### Внутренняя логика (многоагентная система)

В одном чате агент переключается между ролями:

* **Диагност** — выявляет образ жизни, ценности и мотивацию.
* **Консультант** — объясняет решения и их преимущества.
* **Архитектор-дизайнер** — формирует визуальную концепцию и промпты для генерации изображений.
* **Планировщик** — структурирует этапы, сроки и бюджет.
* **Deal Maker** — на финальном этапе предлагает контакт с живым экспертом.

### Ключевые функции

* **Мгновенная визуализация** — генерация фотореалистичных изображений дома и интерьера.
* **Живое ТЗ (Live Brief)** — динамическая панель справа, где в реальном времени фиксируются требования пользователя.
* **Контекстное мышление** — агент анализирует стадию диалога и уровень доверия перед каждым ответом.

### Пользовательский сценарий

* Вход через имиджевый экран.
* Диалог в формате «один вопрос — один шаг».
* Постепенная визуализация концепта.
* Финал — передача сформированного проекта реальному специалисту.

---

## Event Wizard AI

Event Wizard AI — это AI Sales Assistant для индустрии корпоративных мероприятий.
Система автоматизирует процесс продажи от первого контакта до готового коммерческого предложения.

### Общая логика

* Веб-приложение с чатом слева и инфопанелью справа.
* В процессе диалога данные клиента автоматически структурируются и визуализируются.
* Пользователь сразу видит прогресс и сформированное предложение.

### Многоагентная система

Внутри работают специализированные агенты:

* **Агент вопросов** — собирает цели, бюджет, формат и количество гостей.
* **Агент-презентатор** — подбирает сценарий и формирует визуальное КП с расчетами.
* **Агент-защитник** — фильтрует нецелевые запросы.
* **Агент завершения** — финализирует сделку и собирает контакты.

### База знаний

* В систему встроено 15 готовых сценариев корпоративных мероприятий (разные форматы и бюджеты).

### Ценность проекта

* **Event-агентствам** — автоматическая квалификация лидов.
* **Корпоративным клиентам** — мгновенный подбор мероприятий 24/7.
* **Отделам продаж** — рост конверсии за счёт скорости и наглядности.

**Суть проекта:** превращение хаотичного общения с клиентом в структурированную сделку с помощью AI.

СПРАВОЧНИК ЦЕН И ПРОЕКТОВ (ДЛЯ КОНТЕКСТА):
${JSON.stringify(PROJECTS.map(p => ({ title: p.title, price: p.price, description: p.description, tags: p.tags })))}
`;

interface Message {
  id: string;
  role: 'user' | 'assistant';
  content: string;
}

const AiAssistant: React.FC = () => {
  const [isOpen, setIsOpen] = useState(false);
  const [messages, setMessages] = useState<Message[]>([
    { 
      id: 'init', 
      role: 'assistant', 
      content: 'Привет! Я цифровой аватар Алекса. \n\nРасскажите про вашу задачу: вы хотите автоматизировать текущий бизнес или запустить новый стартап?' 
    }
  ]);
  const [inputValue, setInputValue] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const chatSessionRef = useRef<Chat | null>(null);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages, isOpen]);

  const handleScrollToContact = () => {
    const element = document.getElementById('contact');
    if (element) {
      const headerOffset = 100;
      const elementPosition = element.getBoundingClientRect().top;
      const offsetPosition = elementPosition + window.scrollY - headerOffset;
      window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
    }
  };

  const handleSendMessage = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!inputValue.trim() || isLoading) return;

    const userMessage: Message = {
      id: Date.now().toString(),
      role: 'user',
      content: inputValue.trim()
    };

    setMessages(prev => [...prev, userMessage]);
    setInputValue('');
    setIsLoading(true);

    try {
      let assistantContent = "";
      // Безопасное получение ключа. При сборке (Vite/Webpack) process.env.API_KEY заменится на реальный ключ, если он задан.
      const apiKey = process.env.API_KEY; 
      
      if (apiKey) {
        // --- РЕЖИМ С НЕЙРОСЕТЬЮ (ЕСЛИ ЕСТЬ КЛЮЧ) ---
        if (!chatSessionRef.current) {
           const ai = new GoogleGenAI({ apiKey });
           chatSessionRef.current = ai.chats.create({
             model: 'gemini-2.5-flash',
             config: { systemInstruction: SYSTEM_PROMPT }
           });
        }
        
        const response = await chatSessionRef.current.sendMessage({
           message: userMessage.content
        });
        
        assistantContent = response.text || "Извините, не удалось сгенерировать ответ.";

      } else {
        // --- ДЕМО РЕЖИМ (ЕСЛИ КЛЮЧА НЕТ) ---
        // Этот код позволяет сайту отвечать на вопросы о проектах, даже если API ключ не настроен на сервере.
        await new Promise(resolve => setTimeout(resolve, 1000));
        const lowerInput = userMessage.content.toLowerCase();
        
        // 1. Поиск проекта в базе по ключевым словам
        const foundProject = PROJECTS.find(p => 
          lowerInput.includes(p.title.toLowerCase()) || 
          p.tags.some(t => lowerInput.includes(t.toLowerCase())) ||
          (lowerInput.includes('news') && p.title.includes('News')) ||
          (lowerInput.includes('crm') && p.title.includes('Rent')) ||
          (lowerInput.includes('сайт') && p.title.includes('Event'))
        );

        if (foundProject) {
           assistantContent = `**${foundProject.title}** — отличный пример. \n\n${foundProject.description}\n\nОриентировочная стоимость: **${foundProject.price}**. Хотите обсудить похожий проект? [DEMO]`;
        } 
        // 2. Вопросы про цену
        else if (lowerInput.includes('цен') || lowerInput.includes('стоит') || lowerInput.includes('бюджет') || lowerInput.includes('сколько')) {
          assistantContent = "Стоимость разработки варьируется от **150 000 ₽** (простые боты) до **500 000 ₽+** (сложные CRM). \n\nЧтобы назвать точную цифру, мне нужно чуть больше деталей. У вас уже есть ТЗ? [DEMO]";
        } 
        // 3. Вопросы про начало работы / нет ТЗ
        else if (lowerInput.includes('идея') || lowerInput.includes('нет тз') || lowerInput.includes('с чего начать')) {
          assistantContent = "Отсутствие ТЗ — не проблема. Мы можем начать с **Этапа 01 (Аналитика)**. Я помогу сформулировать требования и составить техническое задание. \n\nРасскажите в двух словах, какую проблему бизнеса нужно решить? [DEMO]";
        } 
        // 4. Согласие / Контакты
        else if (lowerInput.includes('заказ') || lowerInput.includes('связ') || lowerInput.includes('контакт') || lowerInput.includes('да') || lowerInput.includes('хочу')) {
          assistantContent = "Отлично! Давайте перейдем к конкретике. Оставьте заявку в форме ниже, и Алекс свяжется с вами. [ACTION:SCROLL_TO_CONTACT]";
        } 
        // 5. Дефолтный ответ
        else {
          assistantContent = "Это интересная задача. Мы специализируемся на AI-автоматизации (LLM, RAG, генерация контента). \n\nМожете уточнить, какой объем данных планируется обрабатывать или сколько пользователей будет в системе? [DEMO]";
        }
      }

      // Обработка Action Tag
      let finalContent = assistantContent;
      let shouldScroll = false;

      if (assistantContent.includes('[ACTION:SCROLL_TO_CONTACT]')) {
        finalContent = assistantContent.replace('[ACTION:SCROLL_TO_CONTACT]', '').trim();
        shouldScroll = true;
      }

      const aiMessage: Message = {
        id: (Date.now() + 1).toString(),
        role: 'assistant',
        content: finalContent
      };

      setMessages(prev => [...prev, aiMessage]);
      
      if (shouldScroll) {
        setTimeout(handleScrollToContact, 1000); 
      }

    } catch (error) {
      console.error(error);
      setMessages(prev => [...prev, {
        id: Date.now().toString(),
        role: 'assistant',
        content: "Произошла ошибка. Пожалуйста, попробуйте позже."
      }]);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <>
      {/* Trigger Button */}
      <button
        onClick={() => setIsOpen(!isOpen)}
        className={`fixed bottom-6 right-6 z-[60] p-4 rounded-full shadow-[0_0_30px_rgba(99,102,241,0.5)] transition-all duration-300 hover:scale-110 active:scale-95 flex items-center justify-center ${
          isOpen ? 'bg-slate-800 text-white rotate-90' : 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white'
        }`}
      >
        {isOpen ? <X size={28} /> : <MessageCircle size={28} />}
        
        {/* Notification Dot if closed */}
        {!isOpen && (
           <span className="absolute -top-1 -right-1 flex h-4 w-4">
             <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
             <span className="relative inline-flex rounded-full h-4 w-4 bg-green-500"></span>
           </span>
        )}
      </button>

      {/* Chat Window */}
      <div 
        className={`fixed bottom-24 right-6 w-[90vw] md:w-[400px] h-[500px] max-h-[70vh] bg-slate-900/95 backdrop-blur-xl border border-indigo-500/30 rounded-2xl shadow-2xl flex flex-col z-[60] transition-all duration-300 origin-bottom-right ${
          isOpen ? 'opacity-100 scale-100 translate-y-0' : 'opacity-0 scale-95 translate-y-10 pointer-events-none'
        }`}
      >
        {/* Header */}
        <div className="p-4 border-b border-slate-800 bg-gradient-to-r from-slate-900 to-slate-800 rounded-t-2xl flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-full bg-indigo-600/20 border border-indigo-500/50 flex items-center justify-center text-indigo-400 shadow-[0_0_15px_rgba(99,102,241,0.2)]">
              <Bot size={24} />
            </div>
            <div>
              <h3 className="font-bold text-white flex items-center gap-2">
                Alex (AI)
                <Sparkles size={14} className="text-yellow-400 animate-pulse" />
              </h3>
              <p className="text-xs text-green-400 font-medium flex items-center gap-1">
                <span className="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
                Online
              </p>
            </div>
          </div>
          <button onClick={() => setIsOpen(false)} className="text-slate-400 hover:text-white">
            <ChevronDown size={20} />
          </button>
        </div>

        {/* Messages Body */}
        <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
          {messages.map((msg) => (
            <div 
              key={msg.id} 
              className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
            >
              <div 
                className={`max-w-[85%] p-3.5 rounded-2xl text-sm leading-relaxed ${
                  msg.role === 'user' 
                    ? 'bg-indigo-600 text-white rounded-tr-none shadow-lg' 
                    : 'bg-slate-800 border border-slate-700 text-slate-200 rounded-tl-none shadow-md'
                }`}
              >
                <ReactMarkdown
                  components={{
                    ul: ({node, ...props}) => <ul className="list-disc ml-4 mb-2 space-y-1" {...props} />,
                    ol: ({node, ...props}) => <ol className="list-decimal ml-4 mb-2 space-y-1" {...props} />,
                    li: ({node, ...props}) => <li className="" {...props} />,
                    p: ({node, ...props}) => <p className="mb-2 last:mb-0" {...props} />,
                    strong: ({node, ...props}) => <span className="font-bold text-white" {...props} />,
                    a: ({node, ...props}) => <a className="text-indigo-300 underline hover:text-white" target="_blank" rel="noopener noreferrer" {...props} />,
                    h1: ({node, ...props}) => <h3 className="font-bold text-white text-base mb-2" {...props} />,
                    h2: ({node, ...props}) => <h4 className="font-bold text-white text-sm mb-2" {...props} />,
                    h3: ({node, ...props}) => <strong className="font-bold text-white block mb-1" {...props} />,
                  }}
                >
                  {msg.content}
                </ReactMarkdown>
              </div>
            </div>
          ))}
          
          {isLoading && (
            <div className="flex justify-start">
              <div className="bg-slate-800 border border-slate-700 p-3 rounded-2xl rounded-tl-none flex gap-1.5 items-center">
                <div className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce [animation-delay:-0.3s]"></div>
                <div className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce [animation-delay:-0.15s]"></div>
                <div className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce"></div>
              </div>
            </div>
          )}
          <div ref={messagesEndRef} />
        </div>

        {/* Footer Input */}
        <form onSubmit={handleSendMessage} className="p-4 border-t border-slate-800 bg-slate-900/50 rounded-b-2xl">
          <div className="relative flex items-center">
            <input
              type="text"
              value={inputValue}
              onChange={(e) => setInputValue(e.target.value)}
              placeholder="Спросите про цены или проекты..."
              className="w-full bg-slate-950 border border-slate-700 rounded-xl pl-4 pr-12 py-3 text-sm text-white focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all placeholder:text-slate-600"
            />
            <button 
              type="submit" 
              disabled={isLoading || !inputValue.trim()}
              className="absolute right-2 p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-500 disabled:opacity-50 disabled:hover:bg-indigo-600 transition-colors"
            >
              <Send size={16} />
            </button>
          </div>
          <div className="text-center mt-2">
            <p className="text-[10px] text-slate-600">
              AI может ошибаться. Проверяйте информацию.
            </p>
          </div>
        </form>
      </div>
    </>
  );
};

export default AiAssistant;